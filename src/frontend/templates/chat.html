{% extends 'base.html' %}
<title>{{ title }}</title>
{% block content %}

<h1>Welcome to the Chat, (ID: {{ client_id }})</h1>

{{ active_connections }}
{{ user_info }}

<div id="connection-status" class="system-message">Connecting...</div>
    
<div id="chat" class="chat-container"></div>

<div class="message-input">
    <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off">
    <button onclick="sendMessage()">Send</button>
</div>

<script>
    const client_id = "{{ client_id }}";
    const ws_url = "{{ websocket_url }}";
    const statusElement = document.getElementById('connection-status');
    const chatElement = document.getElementById('chat');
    
    console.log(`Attempting to connect to WebSocket at ${ws_url}`);
    const ws = new WebSocket(ws_url);

    // Connection opened
    ws.onopen = function(event) {
        console.log('WebSocket connection established', event);
        statusElement.textContent = "Connected to chat";
        statusElement.className = 'system-message connected';
        
        // Send a test message to verify connection
        ws.send(JSON.stringify({
            type: "system",
            message: "Connection established"
        }));
    };

    // Listen for messages
    ws.onmessage = function(event) {
        console.log('Message received:', event.data);
        const message = document.createElement('div');
        
        try {
            const data = JSON.parse(event.data);
            message.textContent = data.message;
            message.className = data.type === 'system' ? 'system-message' : 'user-message';
        } catch {
            message.textContent = event.data;
            message.className = event.data.includes("System:") ? 'system-message' : 'user-message';
        }
        
        chatElement.appendChild(message);
        chatElement.scrollTop = chatElement.scrollHeight;
    };

    // Connection closed
    ws.onclose = function(event) {
        console.log('WebSocket connection closed', event);
        statusElement.textContent = `Disconnected from chat (Code: ${event.code}, Reason: ${event.reason || 'none'})`;
        statusElement.className = 'system-message disconnected';
    };

    // Connection error
    ws.onerror = function(error) {
        console.error('WebSocket error:', error);
        statusElement.textContent = "Connection error - see console for details";
        statusElement.className = 'system-message error';
    };

    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        if (message !== '') {
            console.log('Sending message:', message);
            ws.send(message);
            input.value = '';
        }
    }

    // Allow sending with Enter key
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
</script>

<style>
    .chat-container {
        height: 400px;
        border: 1px solid #ddd;
        padding: 10px;
        overflow-y: scroll;
        margin-bottom: 10px;
    }
    .system-message {
        color: #666;
        font-style: italic;
        margin: 5px 0;
    }
    .system-message.connected {
        color: green;
    }
    .system-message.disconnected {
        color: red;
    }
    .system-message.error {
        color: darkred;
        font-weight: bold;
    }
    .user-message {
        margin: 5px 0;
        padding: 5px;
        border-left: 3px solid #4CAF50;
    }
    .message-input {
        display: flex;
        gap: 10px;
    }
    #messageInput {
        flex-grow: 1;
        padding: 8px;
    }
</style>
{% endblock %}